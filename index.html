<html>
<head>
    <meta charset="UTF-8">
    <style>
      .virtualCursor {
        position: absolute;
        top: 20%;
        left: 20%;
        z-index: 99;
        pointer-events: none;
        opacity: 0.8;
        background: orange;
        height: 30px;
        width: 30px;
        border-radius: 50%;
      }
    </style>
</head>
<body id="bodyHolder">
    <div class="virtualCursor"></div>
    <h1>Todo App</h1>
    <input onchange="addTodo(this)" type="text">
    <ul id="todoList">
    </ul>

    <style>
        .completed {text-decoration: line-through;}
    </style>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script>


        var gun = Gun(['https://gun-us.herokuapp.com/gun','https://gun-eu.herokuapp.com/gun']);
        var gunAppGraph = gun.get('todos');
        var localData = {};
         //start cursor stuff
         function dec2hex (dec) {
          return dec < 10
            ? '0' + String(dec)
            : dec.toString(16)
        }

        // generateId :: Integer -> String
        function generateId (len) {
          var arr = new Uint8Array((len || 40) / 2)
          window.crypto.getRandomValues(arr)
          return Array.from(arr, dec2hex).join('')
        }
        let curX = 0;
        let curY = 0;
        let randomUserID = "9999999";
        if (localStorage.getItem("userID") === null) {
          randomUserID = generateId(10);
          window.localStorage.setItem('userID', randomUserID);
        } else {
          randomUserID = window.localStorage.getItem('userID');
        }


        let firstTime = true;
        //end cursor stuff
        function addNewLocalCursor(nodeID,x, y) {
            gunAppGraph.get(nodeID).put({x: x, y: y,status: 'active'});
        };
        function modifyNewLocalCursor(nodeID,x, y) {
            gunAppGraph.get(nodeID).put({x: x, y: y,status: 'active'});
        };

        function addTodo(element) {
            console.log(`setting "${element.value}" to gun graph...`);
            var date = new Date();
            gunAppGraph.set({thing: element.value, lastUpdated: date.toString(),status: 'active'});
            element.value = '';
        };

        gunAppGraph.map().on(function(node, nodeID){
            console.log(`${nodeID} was updated! Updating local data...`);
            localData[nodeID] = node;
            renderList(localData);
        });

        function renderList(todos) {
            console.log('re-rendering UI...');
            var todoList = document.getElementById("todoList");
            todoList.innerHTML = '';
            for (let [nodeID, node] of Object.entries(todos)) {
                if (node !== null) {
                    console.log('rendering this object');
                    console.log(node.thing);
                    var text = document.createElement('div');
                        text.className = node.status
                        text.innerText = "x: " + node.x + "y: " + node.y;
                    var item = document.createElement('li');
                        item.id = nodeID;
                        item.appendChild(text);
                    todoList.appendChild(item);
                    let vC = document.querySelector('.virtualCursor')
                    vC.style.top = node.y;
                    vC.style.left = node.x;
                }
            }
        }

        function changeStatus(element) {
            var parent = element.parentElement.parentElement;
            var text = parent.firstElementChild;
            var nodeID = parent.id;
            console.log(`changing status of "${nodeID}" in gun graph...`);
            if (text.classList.contains('completed')) {
                var date = new Date();
                gunAppGraph.get(nodeID).put({status: 'active', lastUpdated: date.toString()});
            } else {
                var date = new Date();
                gunAppGraph.get(nodeID).put({status: 'completed', lastUpdated: date.toString()});
            }
        }

        function deleteThing(element) {
            var parent = element.parentElement.parentElement;
            var text = parent.firstElementChild;
            var nodeID = parent.id;
            console.log(`tombstoning "${nodeID}" in gun graph...`);
            gunAppGraph.get(nodeID).put(null);
        }

        document.getElementById('bodyHolder').addEventListener('mousemove', e => {
          curX = e.clientX;
          curY = e.clientY;
          addNewLocalCursor(randomUserID,curX, curY)

        });

    </script>
</body>
</html>
