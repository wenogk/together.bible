<html>
<head>
    <meta charset="UTF-8">
    <style>
      .virtualCursor {
        position: fixed;
        top: 20%;
        left: 20%;
        z-index: 99;
        pointer-events: none;
        opacity: 0.8;
        background: orange;
        height: 30px;
        width: 30px;
        border-radius: 50%;
      }

    </style>
</head>
<body id="bodyHolder">
    <!-- <div class="virtualCursor"></div> -->
<li>Debugger: <span id="debugText"></span></li>
    <ul id="todoList">

    </ul>

    <style>
        .completed {text-decoration: line-through;}
    </style>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/bye.js"></script>
    <script>


        var gun = Gun(['https://mvp-gun.herokuapp.com/gun', 'https://e2eec.herokuapp.com/gun','https://gun-us.herokuapp.com/gun','https://gun-eu.herokuapp.com/gun']);
        var gunAppGraph = gun.get('cursors-bible-together');
        var localData = {};
         //start cursor stuff
         function dec2hex (dec) {
          return dec < 10
            ? '0' + String(dec)
            : dec.toString(16)
        }

        // generateId :: Integer -> String
        function debugText(text) {
          var elem = document.getElementById("debugText");
          elem.innerHTML = text;
        }

        function generateId (len) {
          var arr = new Uint8Array((len || 40) / 2)
          window.crypto.getRandomValues(arr)
          return Array.from(arr, dec2hex).join('')
        }
        let isAmenClicked = false;
        let curX = 0;
        let curY = 0;
        let randomUserID = "9999999";
        var randomColor = "#000000".replace(/0/g,function(){return (~~(Math.random()*16)).toString(16);});
        if (localStorage.getItem("userID") === null) {
          randomUserID = generateId(10);
          window.localStorage.setItem('userID', randomUserID);
        } else {
          randomUserID = window.localStorage.getItem('userID');
        }
        console.log("LOGGED IN USERID" + randomUserID)
        //alert(randomUserID)

        let firstTime = true;
        //end cursor stuff
        function addNewLocalCursor(nodeID,x, y, color, amenClicked = false) {
            let timeNow = Math.floor(Date.now() / 1000);
            let data = {
              userID: nodeID,
              x: x,
              y: y,
              lastUpdated: timeNow,
              color: color,
              status: 'active',
              amenClicked: amenClicked
            };
            console.log("new Data: " + JSON.stringify(data))
            gunAppGraph.get(nodeID).put(data);
            //gunAppGraph.set(data);
        };
        function deleteCursorNode(nodeID) {
          function removeElement(id) {
            var elem = document.getElementById(id);
            if(elem) {
              elem.style.display = "none";
            //return elem.parentNode.removeChild(elem);
            }
        }
          console.log("deleting " + nodeID)
            removeElement(nodeID);
            gunAppGraph.get(nodeID).put(null);
        };

        gunAppGraph.map().on(function(node, nodeID){
            localData[nodeID] = node;
            renderList(localData);
        });

        function ratioToWidth(val) {
          return val*window.innerWidth;
        }
        function widthToRatio(val) {
          return (val/window.innerWidth)*1;
        }
        function ratioToHeight(val) {
          return val*window.innerHeight;
        }
        function heightToRatio(val) {
          return (val/window.innerHeight)*1;
        }
        function renderList(todos) {
            console.log('re-rendering UI...');
            var c = document.getElementById("todoList");
            todoList.innerHTML = '';
            for (let [nodeID, node] of Object.entries(todos)) {
                if (node !== null) {
                    let timeNow = Math.floor(Date.now() / 1000);
                    gunAppGraph.get(nodeID).bye().put(null);
                    if((timeNow-node.lastUpdated)>5 || (node.lastUpdated == null)) {
                      deleteCursorNode(nodeID);
                    } else {
                      //randomColor
                      var cursorExisting = document.getElementById(nodeID);

                      if(cursorExisting) {
                        debugText("cursor exists")
                        cursorExisting.style.display = "block";
                        cursorExisting.style.top = ratioToHeight(node.y);
                        cursorExisting.style.left = ratioToWidth(node.x);
                      } else {
                        debugText("cursor doesnt exist so created")
                        var vCursor = document.createElement('div');
                        vCursor.className = "virtualCursor";
                        vCursor.id = nodeID;
                        vCursor.style.display = "block";
                        vCursor.style.background = node.color;
                        vCursor.style.top = ratioToHeight(node.y);
                        vCursor.style.left = ratioToWidth(node.x);
                        todoList.appendChild(vCursor);
                      }

                      if(node.amenClicked) {
                        playAmenSound();
                      }

                      var text = document.createElement('div');
                          text.className = node.status
                          text.innerText = "nodeID: " + node.userID + " x: " + node.x + " y: " + node.y + " amen clicked: " + node.amenClicked;
                      var item = document.createElement('li');
                          item.id = nodeID;
                          item.appendChild(text);
                      todoList.appendChild(item);
                      // let vC = document.querySelector('.virtualCursor')
                      // vC.style.top = node.y;
                      // vC.style.left = node.x;
                    }
                }
            }
        }


          document.getElementById('bodyHolder').addEventListener('mousemove', e => {
            //console.log("mouse move")
            curX = e.clientX;
            curY = e.clientY;
            addNewLocalCursor(randomUserID, widthToRatio(curX), heightToRatio(curY), randomColor, isAmenClicked)
          });
          let isCurrentUserClickingAmen = false;
          function amenClicked() {
            isAmenClicked = true;
            isCurrentUserClickingAmen = true;
            addNewLocalCursor(randomUserID, widthToRatio(curX), heightToRatio(curY), randomColor, isAmenClicked)
          }
          let isAmenPlaying = false;
          function playAmenSound() {
            if(!isAmenPlaying) {

              isAmenPlaying = true;
              var audio = new Audio('amen.mp3');
              audio.play();
              audio.addEventListener("ended", function(){
               isAmenPlaying = false;
               isAmenClicked = false;
              });
            }
            if(isCurrentUserClickingAmen) {
              isAmenClicked = false;
              isCurrentUserClickingAmen = false;
              addNewLocalCursor(randomUserID, widthToRatio(curX), heightToRatio(curY), randomColor, isAmenClicked)
            }
            // isAmenClicked = false;
            // addNewLocalCursor(randomUserID, widthToRatio(curX), heightToRatio(curY), randomColor, isAmenClicked)
          }

    </script>
    <button onclick="amenClicked()">Amen</button>
</body>
</html>
